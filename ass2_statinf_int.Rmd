---
title: "Tooth Growth Analysis"
author: "Americo"
date: "19 luglio 2015"
output: html_document
---

##Utils
```{r loading packages}
require(dplyr)
require(ggplot2)
require(datasets)
require(tidyr)
options(digits = 3)
setwd("/Users/Americo/Documents/Education/Data_science/Coursera/Statinference/project/ass2_statinference")
```
##Goals
Now in the second portion of the class, we're going to analyze the ToothGrowth data in the R datasets package. 
Load the ToothGrowth data and perform some basic exploratory data analyses 
Provide a basic summary of the data.
Use confidence intervals and/or hypothesis tests to compare tooth growth by supp and dose. (Only use the techniques from class, even if there's other approaches worth considering)
State your conclusions and the assumptions needed for your conclusions. 
Some criteria that you will be evaluated on
Did you  perform an exploratory data analysis of at least a single plot or table highlighting basic features of the data?
Did the student perform some relevant confidence intervals and/or tests?
Were the results of the tests and/or intervals interpreted in the context of the problem correctly? 
Did the student describe the assumptions needed for their conclusions?

##Dataset
Loading the dataset and studying the variables through the codebook and some initial exploration.
```{r loading dataset}
data(ToothGrowth)
?ToothGrowth
head(ToothGrowth)
tail(ToothGrowth)
dim(ToothGrowth)
str(ToothGrowth)
myToothGrowth <- ToothGrowth
```

The dataset is composed by measurements on 10 pigs regarding the length of teeth (variable `len`) after the somministration of three different dose of vitamin (the variable `dose`) and two delivery methods (orange juice or ascorbic acid - the variable `supp`).

##Exploratory data analysis

How delivery methods and doses are distributed?

There is not a column dedicated to the ID of the ten pigs, so I assume that the measurements are ordered this way: each ten observations represents a dose of vitamin, the first 30 with a delivery methods and the second 30 with the other one.
```{r barcharts, fig.height=5, fig.width=7.5}
ggplot(data = myToothGrowth, aes(x = supp, fill = factor(dose))) +
        geom_bar(width = 0.5) +
        guides(fill=guide_legend(reverse=TRUE)) +
        ggtitle("distribution of doses and delivery methods")
```

My assumption (*I assume that the measurements are ordered this way: each ten observations represents a dose of vitamin, the first 30 with a delivery methods and the second 30 with the other one*) seem confirmed by the plot.

Let'see the distribution of teeth's lengths.

```{r first histogram, fig.height=2.5, fig.width=7.5}
ggplot(data = myToothGrowth, aes(x = len)) +
               geom_histogram(binwidth = 1, colour = "black", fill = "gray") +
        ggtitle("Histogram of teeth length")
```

I don't know if this kind of exploration makes sense, because this 60 observations are not really *a population*, are much more the sum of 6 different "snapshot"" of a population.
Let's plot them so.

```{r conditional boxplots, fig.height=2.5, fig.width=7.5}
ggplot(data = myToothGrowth, aes(x = factor(dose), y = len)) +
        geom_boxplot() +
        facet_wrap(~supp) +
        ggtitle("Boxplot of teeth length")
```

It seems that dose influences the growth of lenghts (very expected!) and that ascorbic acide is more effective than orange juice in facilitate this.
Almost all population are quiete symmetrical, which is good for our further analysis. **Infact we are deailing with paired small samples**, so it's likely we are going to use t-test to compare groups, and t-test needs quite normal population to be accurate. Of course we can't check the normality of population (unless we use some tools that were not taugth in the class, but students have been explicitly discouraged in doing so), so we must perform analysis on these small samples. Furthermore, being paired samples, it's better to plot the differences between lengths, as we will test them with the `t distribution`. I will do this in the `statistical analysis` chapter, after some data manipulation.

##Data manipulation

I want to create a dataframe with 7 variables, the 6 measurements and the ID of the subjects. It seems to me the better way to flexibly perform t-tests.

```{r manipulation}
mydfs <- list()
j <- 1:10
for (i in 1:6) {
        mydfs[[i]] <- myToothGrowth[j,]
        names(mydfs[[i]]) <- c(paste("len", i), paste("supp", i),paste("dose", i))
        j <- j + 10
}
myToothGrowth2 <- bind_cols(mydfs)
myToothGrowth2$pig_id <- 1:10

#renaming variables to have a smaller dataframe
myToothGrowth3 <- myToothGrowth2[, seq(1, 19, 3)]
names(myToothGrowth3)  <- c("lenVC_05", "lenVC_1", "lenVC_2", "lenOJ_05", "lenOJ_1", "lenOJ_2", "pig_id")
head(myToothGrowth3)
```

##Statistical analysis

As seen before, we are dealing witg 6 measurements on 10 subjects. These measurements were taken in 2 different conditions, let'say: *Orange juice* and *Ascorbic acid*. So we must be very careful in comparing two measurements belonging to different conditions.

My idea is:

* to compare lengths derived from different doses given with the same delivery method, to see if bigger dose (as we expect) related to bigger length;
* to compare same doses given with different delivery methods, to see if different delivery method relates to different length (looking at the boxplots, i think it worth considering the dose 0.5 and 1, which seems the ones with bigger difference between lengths distributions and their averages).

But first of all I need to perform some check on normality of differences, although the size is very very small. Naming convention is: $VC_1_05 = supp VC dose 1 - supp Vc dose 0.5$

```{r difference dataframe}
myToothGrowth_diff <- data.frame (
        lenVC_1_05 = myToothGrowth3$lenVC_1 - myToothGrowth3$lenVC_05,
        lenVC_2_1 = myToothGrowth3$lenVC_2 - myToothGrowth3$lenVC_1,
        lenVC_2_05 = myToothGrowth3$lenVC_2 - myToothGrowth3$lenVC_05,
        lenOJ_1_05 = myToothGrowth3$lenOJ_1 - myToothGrowth3$lenOJ_05,
        lenOJ_2_1 = myToothGrowth3$lenOJ_2 - myToothGrowth3$lenOJ_1,
        lenOJ_2_05 = myToothGrowth3$lenOJ_2 - myToothGrowth3$lenOJ_05,
        lenVC_OJ_05 = myToothGrowth3$lenOJ_05 - myToothGrowth3$lenVC_05,
        lenVC_OJ_1 = myToothGrowth3$lenOJ_1 - myToothGrowth3$lenVC_1,
        lenVC_OJ_2 = myToothGrowth3$lenOJ_2 - myToothGrowth3$lenVC_2)

head(myToothGrowth_diff)
```

Now let's plot differences and see. I will adjust the binwidth in order to approximate as best as I can normality.

```{r differences plot, fig.height=5, fig.width=7.5}
toothnormalplot <- function(mydf, bin, supp, doseup, dosedown) {
        attach(mydf)
        mytitle <- sprintf("length difference between dose %s and %s given with %s", doseup, dosedown, supp)
        mydf$myx <- eval(parse(text = sprintf("len%s_%s_%s", supp, doseup, dosedown)))
        g1 <- ggplot(data = mydf, aes(x = myx)) +
                geom_histogram(binwidth = bin, colour = "black", fill = "gray") +
                ggtitle(label = mytitle) +
                xlab(label = sprintf("len%s_%s_%s", supp, doseup, dosedown))
        return(g1)
        detach(mydf)
}

toothnormalplot(mydf = myToothGrowth_diff, bin = 3, supp = "VC", doseup = "2", dosedown = "05")




```


```{r function for t plotting}
tplot <- function(dof, tstat, conflev, two = TRUE) {
        myx <- seq(-4, 4, length=100)
        hx <- dnorm(myx)
        degf <- dof
        mydf <- data.frame (myx, myy = dt(myx, degf))
        pcum <- ifelse(two == TRUE, conflev+((1-conflev)/2), conflev)
        tcrit  <- qt(p = pcum, df = dof)
        if (two == TRUE) {
                g1 <- ggplot(mydf, aes(myx, myy)) +
                geom_line(size = 1.2, colour = "black") +
                geom_vline(xintercept = c(-tcrit, tcrit, tstat), colour = c("red", "red", "blue"), size = 0.9) +
                ggtitle(paste("Hypothesis testing for t =", tstat ))
        return(g1)
        } else {
                g2 <- ggplot(mydf, aes(myx, myy)) +
                geom_line(size = 1.2, colour = "black") +
                geom_vline(xintercept = c(tcrit, tstat), colour = c("red", "blue"), size = 0.9) +
                ggtitle(paste("Hypothesis testing for t =", tstat ))
                return(g2)
        }
}
tplot(dof = 9, tstat = 1.2, conflev = 0.95, two = TRUE)
#da perfezionare il grafico per test a due code
```
##Conclusions